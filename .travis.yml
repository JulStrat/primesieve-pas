language: c
dist: bionic

arch:
  - amd64
  - arm64
os:
  - linux
  - osx

osx_image: xcode12

before_install:
    - if [[ $TRAVIS_OS_NAME == linux ]]; then
        sudo apt-get update;
        sudo apt -q install fpc;
        sudo apt -q install libprimesieve-dev;
        fpc -vh -B -O3 -CX -XX -dUSE_ABI6 -Fl/usr/local/lib examples/prev_prime.pas;
      elif [[ $TRAVIS_OS_NAME == osx ]]; then 
        brew update > /dev/null;
        brew install fpc > /dev/null;
        brew install primesieve;
        export DYLD_LIBRARY_PATH=.:$DYLD_LIBRARY_PATH:/usr/local/lib;
        export LD_LIBRARY_PATH=.:$LD_LIBRARY_PATH:/usr/local/lib;        
        sudo update_dyld_shared_cache;
        echo $DYLD_LIBRARY_PATH;
        echo $LD_LIBRARY_PATH;        
        echo $DYLD_FALLBACK_LIBRARY_PATH;                
      fi

install:
  - fpc -B -Cn primesieve_info.pas
  - cat link.res
  - fpc -va -B -O3 -CX -XX -Fl/usr/local/lib primesieve_info.pas
  - fpc -vh -B -O3 -CX -XX -Fl/usr/local/lib examples/count_primes.pas
  - fpc -vh -B -O3 -CX -XX -Fl/usr/local/lib examples/nth_prime.pas  
  - fpc -vh -B -O3 -CX -XX -Fl/usr/local/lib examples/store_primes_in_array.pas  
  - fpc -vh -B -O3 -CX -XX -Fl/usr/local/lib examples/printlets.pas    
  - fpc -vh -B -O3 -CX -XX -Fl/usr/local/lib examples/countlets.pas    
  
script:
  - ./primesieve_info
  - examples/count_primes > examples/count_primes.fpc.out 
  - diff -w examples/count_primes.fpc.out examples/count_primes_c.out
  - diff -w examples/count_primes.dcc64.out examples/count_primes_c.out  
  - examples/nth_prime > examples/nth_prime.fpc.out
  - diff -w examples/nth_prime.fpc.out examples/nth_prime_c.out  
  - diff -w examples/nth_prime.dcc64.out examples/nth_prime_c.out    
  - examples/store_primes_in_array > examples/store_primes_in_array.fpc.out 
  - diff -w examples/store_primes_in_array.fpc.out examples/store_primes_in_array_c.out  
  - diff -w examples/store_primes_in_array.dcc64.out examples/store_primes_in_array_c.out  
  - examples/prev_prime > examples/prev_prime.fpc.out 
  - diff -w examples/prev_prime.fpc.out examples/prev_prime_c.out  
  - diff -w examples/prev_prime.dcc64.out examples/prev_prime_c.out  
  - time examples/printlets 6 0 1000000
  - time examples/countlets 6 0 1000000000
